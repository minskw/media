<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ•Œ Iqra' Digital Jilid 1 - Belajar Membaca Al-Qur'an ğŸ•Œ</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/128/3165/3165231.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Nunito:wght@400;600;700;800&display=swap');
        
        body { 
            font-family: 'Nunito', sans-serif; 
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        .arabic-text {
            font-family: 'Amiri', serif;
            direction: rtl;
            text-align: center;
        }
        
        .title-font { font-family: 'Amiri', serif; }
        
        /* Menu card animations */
        .menu-card {
            transition: all 0.3s ease;
        }
        
        .menu-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        /* Letter animations */
        .letter-glow {
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            transition: all 0.3s ease;
        }
        
        .letter-bounce {
            animation: letterBounce 0.6s ease;
        }
        
        @keyframes letterBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        /* Game animations */
        .game-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .game-card:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }
        
        /* Button styles */
        .btn-islamic {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transition: all 0.2s ease;
        }
        
        .btn-islamic:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(5, 150, 105, 0.4);
        }
        
        .btn-gold {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
        }
        
        .btn-blue {
            background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
        }
        
        .btn-purple {
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        }
        
        /* Modal animations */
        .modal-enter {
            animation: modalEnter 0.4s ease-out;
        }
        
        @keyframes modalEnter {
            0% { opacity: 0; transform: scale(0.8) translateY(-50px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        /* Success animations */
        .success-pulse {
            animation: successPulse 0.6s ease;
        }
        
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Game specific styles */
        .memory-card {
            perspective: 1000px;
        }
        
        .memory-card-inner {
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        
        .memory-card.flipped .memory-card-inner {
            transform: rotateY(180deg);
        }
        
        .memory-card-front, .memory-card-back {
            backface-visibility: hidden;
        }
        
        .memory-card-back {
            transform: rotateY(180deg);
        }
        
        /* Writing Canvas Styles */
        .writing-canvas {
            border: 3px solid #10B981;
            border-radius: 12px;
            background: white;
            cursor: crosshair;
            touch-action: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .writing-guide {
            position: absolute;
            pointer-events: none;
            opacity: 0.2;
            font-family: 'Amiri', serif;
            color: #10B981;
            font-size: 120px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            user-select: none;
        }
        
        .brush-size-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #10B981;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .brush-size-btn.active {
            background: #10B981;
            color: white;
            transform: scale(1.1);
        }
        
        .brush-size-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        
        .color-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 3px solid white;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .color-btn.active {
            border-color: #374151;
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .color-btn:hover {
            transform: scale(1.1);
        }
        
        .writing-letter-btn {
            transition: all 0.2s ease;
        }
        
        .writing-letter-btn:hover {
            transform: scale(1.05);
        }
        
        .writing-letter-btn.active {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(20, 184, 166, 0.4);
        }
        
        /* Canvas container */
        .canvas-container {
            position: relative;
            display: inline-block;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .arabic-text { font-size: 2rem; }
            .menu-card { margin-bottom: 1rem; }
            .writing-guide { font-size: 80px; }
            .canvas-container { width: 280px !important; height: 180px !important; }
            .writing-canvas { width: 280px !important; height: 180px !important; }
        }
        
        @media (min-width: 769px) {
            .arabic-text { font-size: 3rem; }
        }
        
        /* Progress bar */
        .progress-bar {
            transition: width 0.5s ease;
        }
        
        /* Floating elements */
        .floating {
            animation: floating 3s ease-in-out infinite;
        }
        
        @keyframes floating {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        /* Writing feedback animations */
        .writing-feedback {
            animation: feedbackPulse 0.5s ease;
        }
        
        @keyframes feedbackPulse {
            0% { transform: scale(1); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-600 via-emerald-600 to-teal-700 min-h-screen">

    <!-- Professional Header -->
    <div class="bg-gradient-to-br from-green-800 via-emerald-800 to-teal-800 shadow-xl p-4 mb-4 border-b-4 border-yellow-400">
        <!-- Top Header with Logo and Title -->
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-4">
                <img src="https://cdn-icons-png.flaticon.com/128/3165/3165231.png" alt="Iqra Logo" class="w-12 h-12 md:w-16 md:h-16 floating">
                <div>
                    <h1 class="title-font text-lg md:text-2xl text-white font-bold" dir="rtl">
                        Ø¥ÙÙ‚Ù’Ø±ÙØ£Ù’ Ø¯ÙŠØ¬ÙŠØªØ§Ù„ - Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„
                    </h1>
                    <h2 class="text-sm md:text-lg text-yellow-300 font-bold">IQRA' DIGITAL JILID 1</h2>
                    <p class="text-xs text-white/90">Belajar Membaca Huruf Hijaiyah dengan Mudah</p>
                </div>
            </div>
            
            <!-- Setup Profile Button (when no profile) -->
            <div id="setupProfileBtn">
                <button onclick="showProfileSetup()" class="bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white px-4 py-2 rounded-full font-bold transition-all shadow-lg text-sm">
                    ğŸ‘¤ Atur Profil
                </button>
            </div>
        </div>
        
        <!-- Student Identity Section -->
        <div id="studentIdentity" class="hidden bg-white/10 rounded-xl p-4">
            <div class="flex items-center gap-4 mb-3">
                <div class="w-16 h-16 rounded-full overflow-hidden border-3 border-yellow-400 shadow-lg">
                    <img id="userPhoto" src="" alt="Foto Siswa" class="w-full h-full object-cover" style="display: none;">
                    <div id="defaultAvatar" class="w-full h-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white text-2xl font-bold">
                        ğŸ‘¤
                    </div>
                </div>
                <div class="flex-1">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 id="userName" class="text-lg font-bold text-white mb-1">Nama Siswa</h3>
                            <p id="userClass" class="text-yellow-300 text-sm font-medium">Kelas</p>
                        </div>
                        <button onclick="editProfile()" class="bg-white/20 hover:bg-white/30 text-white px-3 py-2 rounded-full text-xs font-bold transition-all">
                            âœï¸ Edit Profil
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Progress Section -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-4 py-2 rounded-lg shadow-lg">
                    <div class="text-center">
                        <div class="text-lg font-bold">â­ <span id="totalScore">0</span></div>
                        <div class="text-xs opacity-90">Total Pahala</div>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-4 py-2 rounded-lg shadow-lg">
                    <div class="text-center">
                        <div class="text-lg font-bold">ğŸ“– <span id="currentPage">1</span>/25</div>
                        <div class="text-xs opacity-90">Halaman Selesai</div>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-4 py-2 rounded-lg shadow-lg">
                    <div class="text-center">
                        <div class="text-lg font-bold">ğŸ… <span id="totalBadges">0</span></div>
                        <div class="text-xs opacity-90">Prestasi Diraih</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Menu -->
    <div class="container mx-auto px-4">
        <div id="main-menu" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            
            <!-- Menu Belajar -->
            <div onclick="showBelajarMenu()" class="menu-card bg-gradient-to-br from-blue-500 to-blue-700 text-white rounded-2xl shadow-xl p-4 cursor-pointer border-2 border-blue-300">
                <div class="text-center">
                    <img src="https://cdn-icons-png.flaticon.com/128/5173/5173666.png" alt="Belajar" class="w-12 h-12 mx-auto mb-3">
                    <h3 class="text-xl font-bold mb-2">BELAJAR</h3>
                    <div class="arabic-text text-lg mb-2 text-yellow-300">ØªÙØ¹ÙÙ„ÙÙ‘Ù…Ù’</div>
                    <p class="text-blue-100 text-xs mb-3">Pelajari 25 halaman Iqra' Jilid 1 dengan metode asli</p>
                    <div class="bg-white/20 text-white px-3 py-1 rounded-full text-xs font-bold">
                        ğŸ­ Makharijul Huruf
                    </div>
                </div>
            </div>

            <!-- Menu Latihan -->
            <div onclick="showLatihanMenu()" class="menu-card bg-gradient-to-br from-purple-500 to-purple-700 text-white rounded-2xl shadow-xl p-4 cursor-pointer border-2 border-purple-300">
                <div class="text-center">
                    <img src="https://cdn-icons-png.flaticon.com/128/11483/11483321.png" alt="Latihan" class="w-12 h-12 mx-auto mb-3">
                    <h3 class="text-xl font-bold mb-2">LATIHAN</h3>
                    <div class="arabic-text text-lg mb-2 text-yellow-300">ØªÙØ¯Ù’Ø±ÙÙŠØ¨</div>
                    <p class="text-purple-100 text-xs mb-3">Game seru untuk mengasah kemampuan membaca huruf</p>
                    <div class="bg-white/20 text-white px-3 py-1 rounded-full text-xs font-bold">
                        ğŸ¯ Game Interaktif
                    </div>
                </div>
            </div>

            <!-- Menu Ujian -->
            <div onclick="showUjianMenu()" class="menu-card bg-gradient-to-br from-orange-500 to-orange-700 text-white rounded-2xl shadow-xl p-4 cursor-pointer border-2 border-orange-300">
                <div class="text-center">
                    <img src="https://cdn-icons-png.flaticon.com/128/5173/5173667.png" alt="Ujian" class="w-12 h-12 mx-auto mb-3">
                    <h3 class="text-xl font-bold mb-2">UJIAN</h3>
                    <div class="arabic-text text-lg mb-2 text-yellow-300">Ø§ÙÙ…Ù’ØªÙØ­ÙØ§Ù†</div>
                    <p class="text-orange-100 text-xs mb-3">Evaluasi kemampuan membaca dengan praktik langsung</p>
                    <div class="bg-white/20 text-white px-3 py-1 rounded-full text-xs font-bold">
                        ğŸ¤ Praktik Membaca
                    </div>
                </div>
            </div>
        </div>

        <!-- Menu Belajar Area -->
        <div id="belajar-area" class="hidden">
            <div class="bg-white/95 rounded-2xl shadow-xl p-3 md:p-4 mb-3 border-2 border-blue-300">
                
                <!-- Belajar Header -->
                <div class="flex justify-between items-center mb-4">
                    <button onclick="backToMainMenu()" class="bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white px-3 py-1 rounded-full font-bold transition-all text-xs">
                        â† Kembali
                    </button>
                    
                    <div class="text-center flex-1">
                        <h2 class="text-md md:text-lg font-bold text-blue-600 mb-1">ğŸ“š BELAJAR IQRA' JILID 1</h2>
                        <div class="flex justify-center gap-2">
                            <span id="belajar-score" class="text-xs font-bold text-blue-600 bg-blue-100 px-2 py-1 rounded-full">Pahala: 0</span>
                            <span id="belajar-progress" class="text-xs font-bold text-green-600 bg-green-100 px-2 py-1 rounded-full">Halaman 1/25</span>
                        </div>
                    </div>
                    
                    <button onclick="testMicrophone()" class="bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white px-2 py-1 rounded-full font-bold text-xs transition-all">
                        ğŸ¤ Tes Mikrofon
                    </button>
                </div>

                <!-- Belajar Content -->
                <div id="belajar-content" class="text-center min-h-64">
                    <!-- Content will be inserted here -->
                </div>

                <!-- Belajar Controls -->
                <div id="belajar-controls" class="mt-6 text-center">
                    <!-- Controls will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Menu Latihan Area -->
        <div id="latihan-area" class="hidden">
            <div class="bg-white/95 rounded-2xl shadow-xl p-4 md:p-6 mb-4 border-2 border-purple-300">
                
                <!-- Latihan Header -->
                <div class="flex justify-between items-center mb-6">
                    <button onclick="backToMainMenu()" class="bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white px-4 py-2 rounded-full font-bold transition-all text-sm">
                        â† Kembali
                    </button>
                    
                    <div class="text-center flex-1">
                        <h2 class="text-lg md:text-2xl font-bold text-purple-600 mb-2">ğŸ® LATIHAN & GAME</h2>
                        <div class="flex justify-center gap-4">
                            <span id="latihan-score" class="text-sm font-bold text-purple-600 bg-purple-100 px-3 py-1 rounded-full">Skor: 0</span>
                            <span id="latihan-level" class="text-sm font-bold text-pink-600 bg-pink-100 px-3 py-1 rounded-full">Level 1</span>
                        </div>
                    </div>
                    
                    <button onclick="showGameMenu()" class="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-3 py-2 rounded-full font-bold text-xs transition-all">
                        ğŸ¯ Menu Game
                    </button>
                </div>

                <!-- Latihan Content -->
                <div id="latihan-content" class="text-center min-h-64">
                    <!-- Content will be inserted here -->
                </div>

                <!-- Latihan Controls -->
                <div id="latihan-controls" class="mt-6 text-center">
                    <!-- Controls will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Menu Ujian Area -->
        <div id="ujian-area" class="hidden">
            <div class="bg-white/95 rounded-2xl shadow-xl p-4 md:p-6 mb-4 border-2 border-orange-300">
                
                <!-- Ujian Header -->
                <div class="flex justify-between items-center mb-6">
                    <button onclick="backToMainMenu()" class="bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white px-4 py-2 rounded-full font-bold transition-all text-sm">
                        â† Kembali
                    </button>
                    
                    <div class="text-center flex-1">
                        <h2 class="text-lg md:text-2xl font-bold text-orange-600 mb-2">ğŸ“ UJIAN & EVALUASI</h2>
                        <div class="flex justify-center gap-4">
                            <span id="ujian-score" class="text-sm font-bold text-orange-600 bg-orange-100 px-3 py-1 rounded-full">Nilai: 0</span>
                            <span id="ujian-progress" class="text-sm font-bold text-red-600 bg-red-100 px-3 py-1 rounded-full">Soal 1/10</span>
                        </div>
                    </div>
                    
                    <button onclick="startUjianPraktik()" class="bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white px-3 py-2 rounded-full font-bold text-xs transition-all">
                        ğŸ¤ Mulai Ujian
                    </button>
                </div>

                <!-- Ujian Content -->
                <div id="ujian-content" class="text-center min-h-64">
                    <!-- Content will be inserted here -->
                </div>

                <!-- Ujian Controls -->
                <div id="ujian-controls" class="mt-6 text-center">
                    <!-- Controls will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Setup Modal -->
    <div id="profileModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="modal-enter bg-white rounded-3xl p-6 text-center max-w-md mx-4 shadow-2xl border-4 border-blue-400">
            <div class="text-4xl mb-4">ğŸ‘¤</div>
            <h3 class="text-2xl font-bold text-blue-600 mb-4">Atur Profil Siswa</h3>
            
            <div class="text-left space-y-4">
                <!-- Photo Upload -->
                <div class="text-center mb-4">
                    <div class="w-24 h-24 mx-auto rounded-full overflow-hidden border-4 border-blue-300 mb-3">
                        <img id="previewPhoto" src="" alt="Preview" class="w-full h-full object-cover" style="display: none;">
                        <div id="previewAvatar" class="w-full h-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white text-3xl font-bold">
                            ğŸ“·
                        </div>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" class="hidden" onchange="previewImage(this)">
                    <button onclick="document.getElementById('photoInput').click()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-full text-sm font-bold transition-all">
                        ğŸ“· Pilih Foto
                    </button>
                </div>
                
                <!-- Name Input -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Nama Lengkap:</label>
                    <input type="text" id="nameInput" placeholder="Masukkan nama lengkap" 
                           class="w-full px-4 py-2 border-2 border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>
                
                <!-- Class Input -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Kelas:</label>
                    <select id="classInput" class="w-full px-4 py-2 border-2 border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none">
                        <option value="">Pilih Kelas</option>
                        <option value="1A">1A</option>
                        <option value="1B">1B</option>
                        <option value="1C">1C</option>
                        <option value="2A">2A</option>
                        <option value="2B">2B</option>
                        <option value="2C">2C</option>
                        <option value="3A">3A</option>
                        <option value="3B">3B</option>
                        <option value="3C">3C</option>
                        <option value="4A">4A</option>
                        <option value="4B">4B</option>
                        <option value="4C">4C</option>
                        <option value="5A">5A</option>
                        <option value="5B">5B</option>
                        <option value="5C">5C</option>
                        <option value="6A">6A</option>
                        <option value="6B">6B</option>
                        <option value="6C">6C</option>
                    </select>
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button onclick="closeProfileModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-full font-bold transition-all">
                    Batal
                </button>
                <button onclick="saveProfile()" class="flex-1 btn-islamic text-white px-4 py-2 rounded-full font-bold transition-all">
                    ğŸ’¾ Simpan
                </button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="modal-enter bg-white rounded-3xl p-6 text-center max-w-md mx-4 shadow-2xl border-4 border-green-400">
            <div class="text-6xl mb-4">ğŸ‰</div>
            <h3 class="text-2xl font-bold text-green-600 mb-3" dir="rtl">Ø¨ÙØ§Ø±ÙÙƒÙ Ø§Ù„Ù„Ù‡Ù ÙÙÙŠÙƒÙ!</h3>
            <p id="successMessage" class="text-lg text-gray-600 mb-4"></p>
            <div id="badgeEarned" class="hidden mb-4">
                <div class="text-4xl mb-2">ğŸ…</div>
                <p class="text-md font-bold text-yellow-600">Prestasi baru!</p>
            </div>
            <button onclick="closeModal()" class="btn-islamic text-white px-6 py-3 rounded-full font-bold text-lg">
                Lanjut! ğŸš€
            </button>
        </div>
    </div>

    <script>
        // Global variables
        let currentPage = 1;
        let totalScore = parseInt(localStorage.getItem('iqra_totalScore') || '0');
        let totalBadges = parseInt(localStorage.getItem('iqra_totalBadges') || '0');
        let currentMenu = 'main';
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let currentPracticePattern = '';
        let isRecordingApproved = false;
        let gameScore = 0;
        let gameLevel = 1;
        let ujianScore = 0;
        let ujianQuestion = 1;
        
        // Practice tracking variables
        let practiceAttempts = 0;
        let successfulAttempts = 0;
        let currentPatternIndex = 0;
        let pagePatterns = [];
        let minPracticeCount = 10;
        let passThreshold = 0.8; // 80% success rate

        // Writing Canvas Variables
        let writingCanvas = null;
        let writingCtx = null;
        let isDrawing = false;
        let currentBrushSize = 5;
        let currentColor = '#10B981';
        let currentLetter = 'Ø£Ù';
        let writingScore = 0;
        let lastX = 0;
        let lastY = 0;

        // Iqra' Jilid 1 Data - Authentic Structure
        const iqraData = {
            pages: [
                {
                    pageNumber: 1,
                    letters: ['Ø£Ù', 'Ø¨Ù'],
                    letterNames: ['A', 'BA'],
                    practicePatterns: [
                        'Ø£Ù Ø¨Ù Ø£Ù',
                        'Ø¨Ù Ø£Ù Ø¨Ù',
                        'Ø£Ù Ø¨Ù Ø¨Ù',
                        'Ø¨Ù Ø£Ù Ø£Ù',
                        'Ø£Ù Ø£Ù Ø¨Ù',
                        'Ø¨Ù Ø¨Ù Ø£Ù'
                    ]
                },
                {
                    pageNumber: 2,
                    letters: ['Ø¨Ù', 'ØªÙ'],
                    letterNames: ['BA', 'TA'],
                    practicePatterns: [
                        'Ø¨Ù ØªÙ Ø¨Ù',
                        'ØªÙ Ø¨Ù ØªÙ',
                        'Ø¨Ù ØªÙ ØªÙ',
                        'ØªÙ Ø¨Ù Ø¨Ù',
                        'Ø¨Ù Ø¨Ù ØªÙ',
                        'ØªÙ ØªÙ Ø¨Ù'
                    ]
                },
                {
                    pageNumber: 3,
                    letters: ['Ø¨Ù', 'ØªÙ', 'Ø«Ù'],
                    letterNames: ['BA', 'TA', 'TSA'],
                    practicePatterns: [
                        'Ø¨Ù ØªÙ Ø«Ù',
                        'Ø«Ù ØªÙ Ø¨Ù',
                        'Ø¨Ù Ø«Ù ØªÙ',
                        'ØªÙ Ø¨Ù Ø«Ù',
                        'Ø«Ù Ø¨Ù ØªÙ',
                        'ØªÙ Ø«Ù Ø¨Ù'
                    ]
                },
                {
                    pageNumber: 4,
                    letters: ['Ø¬Ù'],
                    letterNames: ['JA'],
                    practicePatterns: [
                        'Ø¬Ù Ø¬Ù Ø¬Ù',
                        'Ø¬Ù Ø¨Ù Ø¬Ù',
                        'Ø¬Ù ØªÙ Ø¬Ù',
                        'Ø¬Ù Ø«Ù Ø¬Ù',
                        'Ø¨Ù Ø¬Ù ØªÙ',
                        'Ø«Ù Ø¬Ù Ø¨Ù'
                    ]
                },
                {
                    pageNumber: 5,
                    letters: ['Ø¬Ù', 'Ø­Ù'],
                    letterNames: ['JA', 'HA'],
                    practicePatterns: [
                        'Ø¬Ù Ø­Ù Ø¬Ù',
                        'Ø­Ù Ø¬Ù Ø­Ù',
                        'Ø¬Ù Ø­Ù Ø­Ù',
                        'Ø­Ù Ø¬Ù Ø¬Ù',
                        'Ø¬Ù Ø¬Ù Ø­Ù',
                        'Ø­Ù Ø­Ù Ø¬Ù'
                    ]
                }
            ]
        };

        // Writing Practice Letters Data
        const writingLetters = [
            { letter: 'Ø£Ù', name: 'ALIF', difficulty: 1, guide: 'Garis lurus dari atas ke bawah' },
            { letter: 'Ø¨Ù', name: 'BA', difficulty: 2, guide: 'Garis melengkung dengan titik di bawah' },
            { letter: 'ØªÙ', name: 'TA', difficulty: 2, guide: 'Seperti BA dengan dua titik di atas' },
            { letter: 'Ø«Ù', name: 'TSA', difficulty: 3, guide: 'Seperti BA dengan tiga titik di atas' },
            { letter: 'Ø¬Ù', name: 'JA', difficulty: 3, guide: 'Bentuk seperti mangkuk dengan titik' },
            { letter: 'Ø­Ù', name: 'HA', difficulty: 3, guide: 'Seperti JA tanpa titik' },
            { letter: 'Ø®Ù', name: 'KHA', difficulty: 4, guide: 'Seperti HA dengan titik di atas' },
            { letter: 'Ø¯Ù', name: 'DA', difficulty: 2, guide: 'Setengah lingkaran dengan garis' },
            { letter: 'Ø°Ù', name: 'DZA', difficulty: 3, guide: 'Seperti DA dengan titik di atas' },
            { letter: 'Ø±Ù', name: 'RA', difficulty: 2, guide: 'Garis melengkung pendek' }
        ];

        // Initialize display
        function updateDisplay() {
            document.getElementById('totalScore').textContent = totalScore;
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalBadges').textContent = totalBadges;
            
            // Update menu-specific displays
            if (document.getElementById('belajar-score')) {
                document.getElementById('belajar-score').textContent = `Pahala: ${totalScore}`;
                document.getElementById('belajar-progress').textContent = `Halaman ${currentPage}/25`;
            }
            if (document.getElementById('latihan-score')) {
                document.getElementById('latihan-score').textContent = `Skor: ${gameScore}`;
                document.getElementById('latihan-level').textContent = `Level ${gameLevel}`;
            }
            if (document.getElementById('ujian-score')) {
                document.getElementById('ujian-score').textContent = `Nilai: ${ujianScore}`;
                document.getElementById('ujian-progress').textContent = `Soal ${ujianQuestion}/10`;
            }
        }

        // Navigation Functions - Simple and Direct
        function showBelajarMenu() {
            console.log('ğŸ” showBelajarMenu called');
            currentMenu = 'belajar';
            
            // Hide main menu
            document.getElementById('main-menu').style.display = 'none';
            
            // Show belajar area
            document.getElementById('belajar-area').style.display = 'block';
            document.getElementById('belajar-area').classList.remove('hidden');
            
            loadBelajarPage();
            showMessage('ğŸ“š Masuk ke menu BELAJAR', 'success');
        }

        function showLatihanMenu() {
            console.log('ğŸ” showLatihanMenu called');
            currentMenu = 'latihan';
            
            // Hide main menu
            document.getElementById('main-menu').style.display = 'none';
            
            // Show latihan area
            document.getElementById('latihan-area').style.display = 'block';
            document.getElementById('latihan-area').classList.remove('hidden');
            
            loadLatihanMenu();
            showMessage('ğŸ® Masuk ke menu LATIHAN', 'success');
        }

        function showUjianMenu() {
            console.log('ğŸ” showUjianMenu called');
            currentMenu = 'ujian';
            
            // Hide main menu
            document.getElementById('main-menu').style.display = 'none';
            
            // Show ujian area
            document.getElementById('ujian-area').style.display = 'block';
            document.getElementById('ujian-area').classList.remove('hidden');
            
            loadUjianMenu();
            showMessage('ğŸ“ Masuk ke menu UJIAN', 'success');
        }

        function backToMainMenu() {
            console.log('ğŸ” backToMainMenu called');
            currentMenu = 'main';
            
            // Show main menu
            document.getElementById('main-menu').style.display = 'grid';
            document.getElementById('main-menu').classList.remove('hidden');
            
            // Hide all other areas
            document.getElementById('belajar-area').style.display = 'none';
            document.getElementById('belajar-area').classList.add('hidden');
            
            document.getElementById('latihan-area').style.display = 'none';
            document.getElementById('latihan-area').classList.add('hidden');
            
            document.getElementById('ujian-area').style.display = 'none';
            document.getElementById('ujian-area').classList.add('hidden');
            
            updateDisplay();
            showMessage('ğŸ  Kembali ke menu utama', 'info');
        }

        // Belajar Functions
        function loadBelajarPage() {
            console.log('Loading Belajar Page: ' + currentPage);
            const pageData = iqraData.pages[currentPage - 1];
            
            if (!pageData) {
                showMessage('âŒ Halaman tidak ditemukan', 'error');
                return;
            }
            
            // Reset practice tracking for new page
            practiceAttempts = 0;
            successfulAttempts = 0;
            currentPatternIndex = 0;
            pagePatterns = [...pageData.practicePatterns];
            
            // Get first pattern
            currentPracticePattern = pagePatterns[currentPatternIndex];
            
            updateDisplay();
            
            let content = `
                <!-- Page Number -->
                <div class="text-center mb-4">
                    <div class="bg-blue-600 text-white px-4 py-2 rounded-full inline-block font-bold">
                        ØµÙØ­Ø© ${currentPage} - Halaman ${currentPage}
                    </div>
                </div>
                
                <!-- Top Panel: Letter Introduction -->
                <div class="bg-gradient-to-r from-blue-50 to-green-50 border-2 border-blue-400 rounded-xl p-3 mb-3" style="height: 160px;">
                    <h3 class="text-center text-sm font-bold text-blue-700 mb-2">ğŸ‘† Klik huruf dan ikuti bacaannya</h3>
                    <div class="flex justify-center items-center gap-6 flex-wrap" dir="rtl">
                        ${pageData.letters.map((letter, index) => `
                            <div class="text-center cursor-pointer hover:scale-110 transition-all" onclick="playLetter('${letter}', '${pageData.letterNames[index]}')">
                                <div class="arabic-text text-4xl text-green-700 letter-glow mb-1 letter-bounce">${letter}</div>
                                <div class="text-sm font-bold text-blue-600">${pageData.letterNames[index]}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="text-center mt-2">
                        <button onclick="playAllLetters()" class="btn-islamic text-white px-3 py-1 rounded-full font-bold text-xs transition-all hover:scale-105 shadow-lg">
                            ğŸ”Š Dengar Semua Huruf
                        </button>
                    </div>
                </div>
                
                <!-- Bottom Panel: Practice Section -->
                <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-orange-400 rounded-xl p-4" style="height: 320px;">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-sm font-bold text-orange-700">ğŸ“ Latihan Praktik</h3>
                        <div class="text-xs font-bold text-orange-600 bg-orange-100 px-2 py-1 rounded-full">
                            <span id="practiceProgress">${successfulAttempts}/${minPracticeCount}</span> âœ…
                        </div>
                    </div>
                    
                    <!-- Practice Pattern Display -->
                    <div class="text-center mb-4">
                        <div class="bg-white border-2 border-orange-300 rounded-xl p-4 mb-3 cursor-pointer hover:bg-orange-50 transition-all" onclick="playCurrentPattern()">
                            <div class="arabic-text text-5xl text-orange-700 font-bold mb-2" id="currentPattern" dir="rtl">
                                ${randomPattern}
                            </div>
                            <div class="text-xs text-gray-600">ğŸ‘† Klik untuk mendengar contoh</div>
                        </div>
                        
                        <!-- Practice Status -->
                        <div id="practiceStatus" class="mb-3 p-2 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="text-sm font-bold text-blue-700 mb-1">Status Latihan</div>
                            <div class="text-xs text-blue-600" id="statusText">
                                Dengarkan contoh, lalu rekam bacaan Anda
                            </div>
                        </div>
                        
                        <!-- Practice Controls -->
                        <div class="flex justify-center gap-2 mb-3">
                            <button onclick="playCurrentPattern()" class="btn-gold text-white px-4 py-2 rounded-full font-bold text-sm transition-all hover:scale-105 shadow-lg">
                                ğŸ”Š Dengarkan
                            </button>
                            <button onclick="startRecording()" id="recordBtn" class="bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white px-4 py-2 rounded-full font-bold text-sm transition-all hover:scale-105 shadow-lg">
                                ğŸ¤ Baca
                            </button>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="mb-3">
                            <div class="bg-gray-200 rounded-full h-2 mb-1">
                                <div class="bg-green-500 h-2 rounded-full transition-all duration-500" id="progressBar" style="width: ${(successfulAttempts/minPracticeCount)*100}%"></div>
                            </div>
                            <div class="text-xs text-gray-600">
                                Kemajuan: <span id="progressPercent">${Math.round((successfulAttempts/minPracticeCount)*100)}%</span>
                            </div>
                        </div>
                        
                        <!-- Next Button -->
                        <button onclick="nextBelajarPage()" id="nextBtn" class="bg-gray-400 text-gray-600 px-4 py-2 rounded-full font-bold text-sm cursor-not-allowed" disabled>
                            ğŸ”’ Selesaikan ${minPracticeCount} latihan dulu (${Math.round(passThreshold*100)}% benar)
                        </button>
                    </div>
                </div>
            `;
            
            let controls = `
                <div class="flex justify-center gap-2">
                    ${currentPage > 1 ? `<button onclick="previousBelajarPage()" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-3 py-2 rounded-full font-bold transition-all hover:scale-105 text-xs">â† Sebelumnya</button>` : ''}
                    
                    <button onclick="completeBelajarPage()" class="btn-islamic text-white px-4 py-2 rounded-full font-bold transition-all hover:scale-105 shadow-lg text-xs">
                        âœ… Selesai Halaman
                    </button>
                    
                    ${currentPage < 5 ? `<button onclick="nextBelajarPage()" class="bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white px-3 py-2 rounded-full font-bold transition-all hover:scale-105 text-xs">Berikutnya â†’</button>` : ''}
                </div>
            `;
            
            document.getElementById('belajar-content').innerHTML = content;
            document.getElementById('belajar-controls').innerHTML = controls;
        }

        // Simple Audio System using Web Speech API

        function playLetter(letter, letterName) {
            // Add visual feedback
            const letterElement = event.target.closest('div');
            if (letterElement) {
                letterElement.classList.add('letter-bounce');
                setTimeout(() => letterElement.classList.remove('letter-bounce'), 600);
            }
            
            createEnhancedArabicAudio(letterName);
            showMessage(`ğŸ”Š ${letterName} - ${letter}`, 'info');
            
            if (navigator.vibrate) {
                navigator.vibrate([100]);
            }
        }

        function playAllLetters() {
            const pageData = iqraData.pages[currentPage - 1];
            
            showMessage(`ğŸ”Š Mendengarkan semua huruf...`, 'info');
            
            pageData.letters.forEach((letter, index) => {
                setTimeout(() => {
                    const letterName = pageData.letterNames[index];
                    createEnhancedArabicAudio(letterName);
                }, index * 1200);
            });
        }

        function playCurrentPattern() {
            const pattern = currentPracticePattern || document.getElementById('currentPattern').textContent;
            
            // Convert Arabic pattern to individual letters and play them
            const letters = pattern.split(' ').filter(l => l.trim());
            
            // Cancel any existing speech first
            speechSynthesis.cancel();
            
            showMessage(`ğŸ”Š Contoh bacaan: ${pattern}`, 'info');
            
            letters.forEach((letter, index) => {
                setTimeout(() => {
                    const letterName = convertArabicToName(letter);
                    createEnhancedArabicAudio(letterName);
                }, index * 1000);
            });
        }

        function createEnhancedArabicAudio(letterName) {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                
                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance();
                    
                    // Simplified pronunciation - just the letter sound
                    const pronunciationMap = {
                        'A': 'a',
                        'BA': 'ba',
                        'TA': 'ta', 
                        'TSA': 'tsa',
                        'JA': 'ja',
                        'HA': 'ha',
                        'KHA': 'kha',
                        'DA': 'da',
                        'DZA': 'dza',
                        'RA': 'ra'
                    };
                    
                    utterance.text = pronunciationMap[letterName] || letterName.toLowerCase();
                    utterance.lang = 'id-ID';
                    utterance.rate = 0.6;
                    utterance.pitch = 1.0;
                    utterance.volume = 0.8;
                    
                    utterance.onstart = () => {
                        console.log(`ğŸ”Š Playing: ${letterName}`);
                    };
                    
                    utterance.onerror = (e) => {
                        console.error('Speech error:', e);
                        showMessage(`ğŸ”Š ${letterName}`, 'info');
                    };
                    
                    speechSynthesis.speak(utterance);
                }, 100);
            } else {
                showMessage(`ğŸ”Š ${letterName}`, 'info');
            }
        }

        function convertArabicToName(arabicLetter) {
            const letterMap = {
                'Ø£Ù': 'A', 'Ø¨Ù': 'BA', 'ØªÙ': 'TA', 'Ø«Ù': 'TSA', 'Ø¬Ù': 'JA', 
                'Ø­Ù': 'HA', 'Ø®Ù': 'KHA', 'Ø¯Ù': 'DA', 'Ø°Ù': 'DZA', 'Ø±Ù': 'RA',
                'Ø²Ù': 'ZA', 'Ø³Ù': 'SA', 'Ø´Ù': 'SYA', 'ØµÙ': 'SHA', 'Ø¶Ù': 'DHA',
                'Ø·Ù': 'THA', 'Ø¸Ù': 'ZHA', 'Ø¹Ù': 'A', 'ØºÙ': 'GHA', 'ÙÙ': 'FA',
                'Ù‚Ù': 'QA', 'ÙƒÙ': 'KA', 'Ù„Ù': 'LA', 'Ù…Ù': 'MA', 'Ù†Ù': 'NA',
                'ÙˆÙ': 'WA', 'ÙŠÙ': 'YA'
            };
            return letterMap[arabicLetter] || arabicLetter;
        }



        // Audio Permission and Recording Functions
        async function requestAudioPermission() {
            try {
                // Check if we're on mobile
                const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                if (isMobile) {
                    showMessage('ğŸ“± Meminta izin mikrofon...', 'info');
                }
                
                // Request microphone permission
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 44100
                    }
                });
                
                // Test the stream briefly then stop it
                stream.getTracks().forEach(track => track.stop());
                
                if (isMobile) {
                    showMessage('âœ… Izin mikrofon diberikan!', 'success');
                }
                
                return true;
            } catch (error) {
                console.error('Audio permission error:', error);
                
                let errorMessage = 'âŒ Tidak dapat mengakses mikrofon. ';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'Izin mikrofon ditolak. Silakan berikan izin di pengaturan browser.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'Mikrofon tidak ditemukan.';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage += 'Browser tidak mendukung perekaman audio.';
                } else {
                    errorMessage += 'Terjadi kesalahan. Pastikan mikrofon tersedia dan izin sudah diberikan.';
                }
                
                showMessage(errorMessage, 'error');
                return false;
            }
        }

        async function startRecording() {
            const recordBtn = document.getElementById('recordBtn');
            
            if (!isRecording) {
                // First request permission
                const hasPermission = await requestAudioPermission();
                if (!hasPermission) {
                    return;
                }
                
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true,
                            sampleRate: 44100
                        }
                    });
                    
                    mediaRecorder = new MediaRecorder(stream, {
                        mimeType: MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4'
                    });
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = () => {
                        const mimeType = mediaRecorder.mimeType || 'audio/wav';
                        const audioBlob = new Blob(audioChunks, { type: mimeType });
                        analyzeRecording(audioBlob);
                        
                        // Stop all tracks
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.onerror = (event) => {
                        console.error('MediaRecorder error:', event.error);
                        showMessage('âŒ Terjadi kesalahan saat merekam.', 'error');
                        isRecording = false;
                    };
                    
                    mediaRecorder.start(1000); // Collect data every second
                    isRecording = true;
                    
                    recordBtn.innerHTML = 'â¹ï¸ Berhenti Rekam';
                    recordBtn.className = 'bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-2 py-1 rounded-full font-bold text-xs transition-all hover:scale-105 shadow-lg';
                    
                    showMessage('ğŸ¤ Sedang merekam... Bacakan pola yang ditampilkan!', 'info');
                    
                    // Vibrate on mobile if supported
                    if (navigator.vibrate) {
                        navigator.vibrate([200]);
                    }
                    
                    // Auto stop after 10 seconds
                    setTimeout(() => {
                        if (isRecording) {
                            stopRecording();
                        }
                    }, 10000);
                    
                } catch (error) {
                    console.error('Error starting recording:', error);
                    showMessage('âŒ Gagal memulai perekaman. Coba lagi.', 'error');
                }
            } else {
                stopRecording();
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                const recordBtn = document.getElementById('recordBtn');
                recordBtn.innerHTML = 'ğŸ¤ Rekam Bacaan';
                recordBtn.className = 'bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white px-4 py-2 rounded-full font-bold text-sm transition-all hover:scale-105 shadow-lg';
                
                showMessage('â¹ï¸ Rekaman selesai. Sedang menganalisis...', 'info');
            }
        }

        function analyzeRecording(audioBlob) {
            updatePracticeStatus('ğŸ¤– AI sedang menganalisis bacaan...', 'analyzing');
            
            // Enhanced analysis simulation with multiple factors
            setTimeout(() => {
                practiceAttempts++;
                
                // Simulate more sophisticated analysis
                const baseAccuracy = Math.random();
                const durationFactor = audioBlob.size > 5000 ? 0.2 : 0; // Bonus for adequate length
                const consistencyFactor = Math.random() * 0.1; // Random consistency bonus
                
                const finalScore = Math.min(1.0, baseAccuracy + durationFactor + consistencyFactor);
                
                // More stringent scoring for better accuracy
                if (finalScore > 0.75) {
                    // Excellent reading
                    successfulAttempts++;
                    updatePracticeStatus('ğŸ‰ Excellent! Bacaan sangat baik dan jelas!', 'success');
                    showMessage('ğŸ‰ Ø¨ÙØ§Ø±ÙÙƒÙ Ø§Ù„Ù„Ù‡Ù ÙÙÙŠÙƒÙ! Bacaan sangat baik!', 'success');
                    
                    totalScore += 100;
                    
                    // Move to next pattern automatically
                    setTimeout(() => {
                        moveToNextPattern();
                    }, 1500);
                    
                } else if (finalScore > 0.65) {
                    // Good reading
                    successfulAttempts++;
                    updatePracticeStatus('ğŸ‘ Bagus! Bacaan sudah benar dan jelas.', 'success');
                    showMessage('ğŸ‘ Alhamdulillah! Bacaan sudah benar!', 'success');
                    
                    totalScore += 75;
                    
                    // Move to next pattern automatically
                    setTimeout(() => {
                        moveToNextPattern();
                    }, 1500);
                    
                } else if (finalScore > 0.5) {
                    // Acceptable but needs improvement
                    updatePracticeStatus('ğŸ”„ Cukup baik, tapi masih bisa diperbaiki. Coba lagi!', 'warning');
                    showMessage('ğŸ¤² Bacaan cukup baik! Coba sekali lagi untuk hasil yang lebih baik.', 'info');
                    
                    totalScore += 25;
                    
                } else if (finalScore > 0.35) {
                    // Needs more practice
                    updatePracticeStatus('ğŸ“š Belum tepat. Dengarkan contoh lagi dan ulangi.', 'error');
                    showMessage('ğŸ¤² Coba dengarkan contoh sekali lagi dan ulangi dengan lebih jelas.', 'error');
                    
                    // Auto play example
                    setTimeout(() => {
                        playCurrentPattern();
                    }, 1000);
                    
                } else {
                    // Poor reading - needs significant improvement
                    updatePracticeStatus('âŒ Bacaan belum jelas. Dengarkan baik-baik dan coba lagi.', 'error');
                    showMessage('ğŸ¤² Bacaan belum jelas. Dengarkan contoh dengan seksama dan coba lagi.', 'error');
                    
                    // Auto play example
                    setTimeout(() => {
                        playCurrentPattern();
                    }, 1000);
                }
                
                // Update progress
                updatePracticeProgress();
                localStorage.setItem('iqra_totalScore', totalScore.toString());
                updateDisplay();
                
            }, 2000 + Math.random() * 1000); // Variable analysis time for realism
        }

        function updatePracticeStatus(message, type = 'info') {
            const statusElement = document.getElementById('statusText');
            const statusContainer = document.getElementById('practiceStatus');
            
            if (statusElement && statusContainer) {
                statusElement.textContent = message;
                
                // Update container styling based on type
                statusContainer.className = 'mb-3 p-2 rounded-lg border';
                switch(type) {
                    case 'success':
                        statusContainer.className += ' bg-green-50 border-green-200';
                        statusElement.className = 'text-xs text-green-700';
                        break;
                    case 'error':
                        statusContainer.className += ' bg-red-50 border-red-200';
                        statusElement.className = 'text-xs text-red-700';
                        break;
                    case 'warning':
                        statusContainer.className += ' bg-yellow-50 border-yellow-200';
                        statusElement.className = 'text-xs text-yellow-700';
                        break;
                    case 'analyzing':
                        statusContainer.className += ' bg-purple-50 border-purple-200';
                        statusElement.className = 'text-xs text-purple-700';
                        break;
                    default:
                        statusContainer.className += ' bg-blue-50 border-blue-200';
                        statusElement.className = 'text-xs text-blue-600';
                }
            }
        }

        function updatePracticeProgress() {
            // Update progress counter
            const progressElement = document.getElementById('practiceProgress');
            if (progressElement) {
                progressElement.textContent = `${successfulAttempts}/${minPracticeCount}`;
            }
            
            // Update progress bar
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            if (progressBar && progressPercent) {
                const percentage = Math.round((successfulAttempts / minPracticeCount) * 100);
                progressBar.style.width = `${Math.min(100, percentage)}%`;
                progressPercent.textContent = `${Math.min(100, percentage)}%`;
            }
            
            // Update next button
            updateNextButton();
        }

        function updateNextButton() {
            const nextBtn = document.getElementById('nextBtn');
            if (nextBtn) {
                const successRate = practiceAttempts > 0 ? successfulAttempts / practiceAttempts : 0;
                const canProceed = successfulAttempts >= minPracticeCount && successRate >= passThreshold;
                
                if (canProceed) {
                    nextBtn.className = 'btn-islamic text-white px-4 py-2 rounded-full font-bold text-sm transition-all hover:scale-105 shadow-lg';
                    nextBtn.innerHTML = 'âœ… Lanjut ke Halaman Berikutnya';
                    nextBtn.disabled = false;
                } else {
                    const remaining = minPracticeCount - successfulAttempts;
                    const requiredPercent = Math.round(passThreshold * 100);
                    nextBtn.className = 'bg-gray-400 text-gray-600 px-4 py-2 rounded-full font-bold text-sm cursor-not-allowed';
                    
                    if (remaining > 0) {
                        nextBtn.innerHTML = `ğŸ”’ Butuh ${remaining} latihan lagi (${requiredPercent}% benar)`;
                    } else {
                        const currentPercent = Math.round(successRate * 100);
                        nextBtn.innerHTML = `ğŸ”’ Tingkatkan akurasi (${currentPercent}% â†’ ${requiredPercent}%)`;
                    }
                    nextBtn.disabled = true;
                }
            }
        }

        function moveToNextPattern() {
            // Move to next pattern in the list
            currentPatternIndex = (currentPatternIndex + 1) % pagePatterns.length;
            currentPracticePattern = pagePatterns[currentPatternIndex];
            
            // Update pattern display
            const patternElement = document.getElementById('currentPattern');
            if (patternElement) {
                patternElement.textContent = currentPracticePattern;
            }
            
            // Update status
            updatePracticeStatus('ğŸ“ Pola baru! Dengarkan dan praktikkan.', 'info');
            
            // Auto play new pattern
            setTimeout(() => {
                playCurrentPattern();
            }, 500);
        }

        // Page Navigation
        function nextBelajarPage() {
            const successRate = practiceAttempts > 0 ? successfulAttempts / practiceAttempts : 0;
            const canProceed = successfulAttempts >= minPracticeCount && successRate >= passThreshold;
            
            if (!canProceed) {
                const remaining = minPracticeCount - successfulAttempts;
                const requiredPercent = Math.round(passThreshold * 100);
                
                if (remaining > 0) {
                    showMessage(`ğŸ¤ Selesaikan ${remaining} latihan lagi dengan akurasi ${requiredPercent}%!`, 'error');
                } else {
                    const currentPercent = Math.round(successRate * 100);
                    showMessage(`ğŸ“ˆ Tingkatkan akurasi dari ${currentPercent}% menjadi ${requiredPercent}%!`, 'error');
                }
                return;
            }
            
            if (currentPage < 5) {
                currentPage++;
                loadBelajarPage();
                showMessage(`ğŸ“– Masuk ke Halaman ${currentPage}! Alhamdulillah!`, 'success');
            } else {
                completeBelajarPage();
            }
        }

        function previousBelajarPage() {
            if (currentPage > 1) {
                currentPage--;
                isRecordingApproved = false;
                loadBelajarPage();
                showMessage(`ğŸ“– Halaman ${currentPage}`, 'info');
            }
        }

        function completeBelajarPage() {
            totalScore += 50;
            localStorage.setItem('iqra_totalScore', totalScore.toString());
            
            if (currentPage >= 5) {
                // Demo completed
                totalBadges++;
                localStorage.setItem('iqra_totalBadges', totalBadges.toString());
                
                document.getElementById('successMessage').textContent = 
                    `Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡! Kamu berhasil menyelesaikan demo Iqra' Jilid 1! Total pahala: ${totalScore}`;
                
                document.getElementById('badgeEarned').classList.remove('hidden');
                document.getElementById('successModal').classList.remove('hidden');
                document.getElementById('successModal').classList.add('flex');
            } else {
                showMessage('âœ… Halaman selesai! Alhamdulillah, lanjut ke halaman berikutnya.', 'success');
                setTimeout(() => {
                    nextBelajarPage();
                }, 1500);
            }
            
            updateDisplay();
        }

        // Latihan Functions
        function loadLatihanMenu() {
            updateDisplay();
            
            let content = `
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-bold text-purple-600 mb-4">ğŸ® Pilih Game Latihan</h3>
                    <p class="text-gray-600">Asah kemampuan membaca huruf Hijaiyah dengan game seru!</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Memory Game -->
                    <div class="game-card bg-gradient-to-br from-pink-400 to-pink-600 text-white rounded-xl p-6 shadow-lg" onclick="startMemoryGame()">
                        <div class="text-center">
                            <div class="text-5xl mb-3">ğŸ§ </div>
                            <h4 class="text-xl font-bold mb-2">Memory Game</h4>
                            <p class="text-pink-100 text-sm mb-3">Cocokkan huruf dengan suaranya</p>
                            <div class="bg-white/20 px-3 py-1 rounded-full text-xs font-bold">Level 1-5</div>
                        </div>
                    </div>
                    
                    <!-- Quiz Game -->
                    <div class="game-card bg-gradient-to-br from-indigo-400 to-indigo-600 text-white rounded-xl p-6 shadow-lg" onclick="startQuizGame()">
                        <div class="text-center">
                            <div class="text-5xl mb-3">â“</div>
                            <h4 class="text-xl font-bold mb-2">Quiz Huruf</h4>
                            <p class="text-indigo-100 text-sm mb-3">Tebak nama huruf yang ditampilkan</p>
                            <div class="bg-white/20 px-3 py-1 rounded-full text-xs font-bold">10 Soal</div>
                        </div>
                    </div>
                    
                    <!-- Speed Game -->
                    <div class="game-card bg-gradient-to-br from-green-400 to-green-600 text-white rounded-xl p-6 shadow-lg" onclick="startSpeedGame()">
                        <div class="text-center">
                            <div class="text-5xl mb-3">âš¡</div>
                            <h4 class="text-xl font-bold mb-2">Speed Reading</h4>
                            <p class="text-green-100 text-sm mb-3">Baca huruf secepat mungkin</p>
                            <div class="bg-white/20 px-3 py-1 rounded-full text-xs font-bold">60 Detik</div>
                        </div>
                    </div>
                    
                    <!-- Pattern Game -->
                    <div class="game-card bg-gradient-to-br from-orange-400 to-orange-600 text-white rounded-xl p-6 shadow-lg" onclick="startPatternGame()">
                        <div class="text-center">
                            <div class="text-5xl mb-3">ğŸ¯</div>
                            <h4 class="text-xl font-bold mb-2">Pattern Match</h4>
                            <p class="text-orange-100 text-sm mb-3">Ikuti pola bacaan yang diberikan</p>
                            <div class="bg-white/20 px-3 py-1 rounded-full text-xs font-bold">Pola Acak</div>
                        </div>
                    </div>
                    
                    <!-- Writing Practice -->
                    <div class="game-card bg-gradient-to-br from-teal-400 to-teal-600 text-white rounded-xl p-6 shadow-lg" onclick="startWritingPractice()">
                        <div class="text-center">
                            <div class="text-5xl mb-3">âœï¸</div>
                            <h4 class="text-xl font-bold mb-2">Latihan Menulis</h4>
                            <p class="text-teal-100 text-sm mb-3">Belajar menulis huruf Hijaiyah</p>
                            <div class="bg-white/20 px-3 py-1 rounded-full text-xs font-bold">Kanvas Digital</div>
                        </div>
                    </div>
                    
                    <!-- Progress Report -->
                    <div class="game-card bg-gradient-to-br from-gray-400 to-gray-600 text-white rounded-xl p-6 shadow-lg" onclick="showProgressReport()">
                        <div class="text-center">
                            <div class="text-5xl mb-3">ğŸ“Š</div>
                            <h4 class="text-xl font-bold mb-2">Laporan</h4>
                            <p class="text-gray-100 text-sm mb-3">Lihat kemajuan belajar Anda</p>
                            <div class="bg-white/20 px-3 py-1 rounded-full text-xs font-bold">Statistik</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('latihan-content').innerHTML = content;
            document.getElementById('latihan-controls').innerHTML = '';
        }

        // Writing Practice Functions
        function startWritingPractice() {
            writingScore = 0;
            currentLetter = writingLetters[0].letter;
            
            let content = `
                <div class="text-center mb-6">
                    <h3 class="text-xl font-bold text-teal-600 mb-2">âœï¸ Latihan Menulis Huruf Hijaiyah</h3>
                    <div class="flex justify-center gap-4 mb-4">
                        <span class="bg-teal-100 text-teal-600 px-3 py-1 rounded-full text-sm font-bold">Skor: <span id="writingScore">${writingScore}</span></span>
                        <span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-sm font-bold">Huruf: <span id="currentWritingLetter" class="arabic-text">${currentLetter}</span></span>
                    </div>
                </div>
                
                <!-- Letter Selection -->
                <div class="mb-4">
                    <h4 class="text-center text-sm font-bold text-gray-700 mb-3">Pilih huruf yang ingin dipraktikkan:</h4>
                    <div class="flex flex-wrap justify-center gap-2 mb-4">
                        ${writingLetters.map((letterData, index) => `
                            <button onclick="selectWritingLetter('${letterData.letter}', '${letterData.name}')" 
                                    class="writing-letter-btn ${letterData.letter === currentLetter ? 'bg-teal-500 text-white' : 'bg-white text-teal-600 border-2 border-teal-300'} px-3 py-2 rounded-lg font-bold transition-all hover:scale-105">
                                <div class="arabic-text text-lg">${letterData.letter}</div>
                                <div class="text-xs">${letterData.name}</div>
                            </button>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Writing Canvas Area -->
                <div class="bg-white border-2 border-teal-300 rounded-xl p-4 mb-4">
                    <div class="text-center mb-4">
                        <h4 class="text-lg font-bold text-teal-600 mb-2">Tulis Huruf: <span class="arabic-text text-2xl text-teal-700">${currentLetter}</span></h4>
                        <p class="text-sm text-gray-600 mb-2">Ikuti bentuk huruf yang ditampilkan dengan jari atau stylus</p>
                        <div id="writingGuideText" class="text-xs text-teal-600 font-medium">${writingLetters.find(l => l.letter === currentLetter)?.guide || ''}</div>
                    </div>
                    
                    <!-- Canvas Container -->
                    <div class="flex justify-center mb-4">
                        <div class="canvas-container relative" style="width: 320px; height: 200px;">
                            <canvas id="writingCanvas" class="writing-canvas absolute inset-0" width="320" height="200"></canvas>
                            <div class="writing-guide absolute inset-0" id="writingGuide">${currentLetter}</div>
                        </div>
                    </div>
                    
                    <!-- Canvas Controls -->
                    <div class="flex flex-col md:flex-row justify-center items-center gap-4 mt-4">
                        <!-- Brush Size -->
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-bold text-gray-600">Ukuran:</span>
                            <button onclick="setBrushSize(3)" class="brush-size-btn ${currentBrushSize === 3 ? 'active' : ''}">
                                <div class="w-2 h-2 bg-current rounded-full"></div>
                            </button>
                            <button onclick="setBrushSize(5)" class="brush-size-btn ${currentBrushSize === 5 ? 'active' : ''}">
                                <div class="w-3 h-3 bg-current rounded-full"></div>
                            </button>
                            <button onclick="setBrushSize(8)" class="brush-size-btn ${currentBrushSize === 8 ? 'active' : ''}">
                                <div class="w-4 h-4 bg-current rounded-full"></div>
                            </button>
                        </div>
                        
                        <!-- Colors -->
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-bold text-gray-600">Warna:</span>
                            <button onclick="setColor('#10B981')" class="color-btn ${currentColor === '#10B981' ? 'active' : ''}" style="background-color: #10B981;"></button>
                            <button onclick="setColor('#3B82F6')" class="color-btn ${currentColor === '#3B82F6' ? 'active' : ''}" style="background-color: #3B82F6;"></button>
                            <button onclick="setColor('#EF4444')" class="color-btn ${currentColor === '#EF4444' ? 'active' : ''}" style="background-color: #EF4444;"></button>
                            <button onclick="setColor('#F59E0B')" class="color-btn ${currentColor === '#F59E0B' ? 'active' : ''}" style="background-color: #F59E0B;"></button>
                            <button onclick="setColor('#8B5CF6')" class="color-btn ${currentColor === '#8B5CF6' ? 'active' : ''}" style="background-color: #8B5CF6;"></button>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex gap-2">
                            <button onclick="clearCanvas()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg font-bold text-sm transition-all">
                                ğŸ—‘ï¸ Hapus
                            </button>
                            <button onclick="checkWriting()" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg font-bold text-sm transition-all">
                                âœ… Periksa
                            </button>
                        </div>
                    </div>
                    
                    <!-- Writing Feedback -->
                    <div id="writingFeedback" class="mt-4 text-center hidden">
                        <div class="writing-feedback bg-green-50 border-2 border-green-200 rounded-lg p-3">
                            <div class="text-green-600 font-bold text-sm" id="feedbackText"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Writing Tips -->
                <div class="bg-teal-50 border-2 border-teal-200 rounded-xl p-4">
                    <h4 class="text-sm font-bold text-teal-700 mb-2">ğŸ’¡ Tips Menulis:</h4>
                    <ul class="text-xs text-teal-600 space-y-1">
                        <li>â€¢ Ikuti bentuk huruf yang ditampilkan dengan transparan</li>
                        <li>â€¢ Mulai dari titik yang tepat dan ikuti arah penulisan</li>
                        <li>â€¢ Gunakan jari atau stylus untuk hasil terbaik</li>
                        <li>â€¢ Berlatihlah berulang-ulang untuk menguasai bentuk huruf</li>
                        <li>â€¢ Perhatikan proporsi dan ukuran huruf</li>
                    </ul>
                </div>
            `;
            
            let controls = `
                <div class="flex justify-center gap-4">
                    <button onclick="loadLatihanMenu()" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-4 py-2 rounded-full font-bold transition-all">
                        â† Kembali
                    </button>
                    <button onclick="nextWritingLetter()" class="bg-gradient-to-r from-teal-500 to-teal-600 hover:from-teal-600 hover:to-teal-700 text-white px-4 py-2 rounded-full font-bold transition-all">
                        Huruf Berikutnya â†’
                    </button>
                </div>
            `;
            
            document.getElementById('latihan-content').innerHTML = content;
            document.getElementById('latihan-controls').innerHTML = controls;
            
            // Initialize canvas after content is loaded
            setTimeout(() => {
                initializeWritingCanvas();
            }, 100);
            
            showMessage('âœï¸ Latihan menulis dimulai! Ikuti bentuk huruf yang ditampilkan.', 'success');
        }

        function initializeWritingCanvas() {
            writingCanvas = document.getElementById('writingCanvas');
            if (!writingCanvas) {
                console.error('Writing canvas not found');
                return;
            }
            
            writingCtx = writingCanvas.getContext('2d');
            
            // Set canvas properties
            writingCtx.lineCap = 'round';
            writingCtx.lineJoin = 'round';
            writingCtx.strokeStyle = currentColor;
            writingCtx.lineWidth = currentBrushSize;
            
            // Clear canvas
            writingCtx.clearRect(0, 0, writingCanvas.width, writingCanvas.height);
            
            // Mouse events
            writingCanvas.addEventListener('mousedown', startDrawing);
            writingCanvas.addEventListener('mousemove', draw);
            writingCanvas.addEventListener('mouseup', stopDrawing);
            writingCanvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events for mobile
            writingCanvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            writingCanvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            writingCanvas.addEventListener('touchend', handleTouchEnd, { passive: false });
            
            console.log('Writing canvas initialized successfully');
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = writingCanvas.getBoundingClientRect();
            const scaleX = writingCanvas.width / rect.width;
            const scaleY = writingCanvas.height / rect.height;
            
            lastX = (e.clientX - rect.left) * scaleX;
            lastY = (e.clientY - rect.top) * scaleY;
            
            writingCtx.beginPath();
            writingCtx.moveTo(lastX, lastY);
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const rect = writingCanvas.getBoundingClientRect();
            const scaleX = writingCanvas.width / rect.width;
            const scaleY = writingCanvas.height / rect.height;
            
            const currentX = (e.clientX - rect.left) * scaleX;
            const currentY = (e.clientY - rect.top) * scaleY;
            
            writingCtx.beginPath();
            writingCtx.moveTo(lastX, lastY);
            writingCtx.lineTo(currentX, currentY);
            writingCtx.stroke();
            
            lastX = currentX;
            lastY = currentY;
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                writingCtx.beginPath();
            }
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = writingCanvas.getBoundingClientRect();
            const scaleX = writingCanvas.width / rect.width;
            const scaleY = writingCanvas.height / rect.height;
            
            isDrawing = true;
            lastX = (touch.clientX - rect.left) * scaleX;
            lastY = (touch.clientY - rect.top) * scaleY;
            
            writingCtx.beginPath();
            writingCtx.moveTo(lastX, lastY);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (!isDrawing) return;
            
            const touch = e.touches[0];
            const rect = writingCanvas.getBoundingClientRect();
            const scaleX = writingCanvas.width / rect.width;
            const scaleY = writingCanvas.height / rect.height;
            
            const currentX = (touch.clientX - rect.left) * scaleX;
            const currentY = (touch.clientY - rect.top) * scaleY;
            
            writingCtx.beginPath();
            writingCtx.moveTo(lastX, lastY);
            writingCtx.lineTo(currentX, currentY);
            writingCtx.stroke();
            
            lastX = currentX;
            lastY = currentY;
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            stopDrawing();
        }

        function setBrushSize(size) {
            currentBrushSize = size;
            if (writingCtx) {
                writingCtx.lineWidth = size;
            }
            
            // Update button states
            document.querySelectorAll('.brush-size-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.brush-size-btn').classList.add('active');
            
            showMessage(`âœï¸ Ukuran kuas diubah ke ${size}px`, 'info');
        }

        function setColor(color) {
            currentColor = color;
            if (writingCtx) {
                writingCtx.strokeStyle = color;
            }
            
            // Update button states
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const colorNames = {
                '#10B981': 'hijau',
                '#3B82F6': 'biru',
                '#EF4444': 'merah',
                '#F59E0B': 'kuning',
                '#8B5CF6': 'ungu'
            };
            
            showMessage(`ğŸ¨ Warna diubah ke ${colorNames[color] || 'warna baru'}`, 'info');
        }

        function clearCanvas() {
            if (writingCtx && writingCanvas) {
                writingCtx.clearRect(0, 0, writingCanvas.width, writingCanvas.height);
                
                // Hide feedback
                const feedback = document.getElementById('writingFeedback');
                if (feedback) {
                    feedback.classList.add('hidden');
                }
            }
            showMessage('ğŸ—‘ï¸ Kanvas dibersihkan!', 'info');
        }

        function selectWritingLetter(letter, name) {
            currentLetter = letter;
            
            // Update display
            const currentLetterElement = document.getElementById('currentWritingLetter');
            if (currentLetterElement) {
                currentLetterElement.textContent = letter;
            }
            
            const guideElement = document.getElementById('writingGuide');
            if (guideElement) {
                guideElement.textContent = letter;
            }
            
            // Update guide text
            const guideTextElement = document.getElementById('writingGuideText');
            if (guideTextElement) {
                const letterData = writingLetters.find(l => l.letter === letter);
                guideTextElement.textContent = letterData?.guide || '';
            }
            
            // Update button states
            document.querySelectorAll('.writing-letter-btn').forEach(btn => {
                btn.classList.remove('bg-teal-500', 'text-white', 'active');
                btn.classList.add('bg-white', 'text-teal-600', 'border-2', 'border-teal-300');
            });
            event.target.closest('.writing-letter-btn').classList.remove('bg-white', 'text-teal-600', 'border-2', 'border-teal-300');
            event.target.closest('.writing-letter-btn').classList.add('bg-teal-500', 'text-white', 'active');
            
            // Clear canvas
            clearCanvas();
            
            // Play letter sound
            const letterName = convertArabicToName(letter);
            createEnhancedArabicAudio(letterName);
            
            showMessage(`âœï¸ Sekarang berlatih menulis: ${name} - ${letter}`, 'info');
        }

        function checkWriting() {
            // Check if there's any drawing on canvas
            const imageData = writingCtx.getImageData(0, 0, writingCanvas.width, writingCanvas.height);
            const pixels = imageData.data;
            let hasDrawing = false;
            
            // Check for non-transparent pixels
            for (let i = 3; i < pixels.length; i += 4) {
                if (pixels[i] > 0) {
                    hasDrawing = true;
                    break;
                }
            }
            
            if (!hasDrawing) {
                showMessage('âŒ Belum ada tulisan! Coba tulis huruf terlebih dahulu.', 'error');
                return;
            }
            
            // Simulate writing analysis based on stroke count and coverage
            const strokeDensity = calculateStrokeDensity(imageData);
            const coverage = calculateCoverage(imageData);
            
            let score = 0;
            let message = '';
            let feedbackClass = '';
            
            // Scoring algorithm
            const accuracy = (strokeDensity * 0.4 + coverage * 0.6) * 100;
            
            if (accuracy > 85) {
                score = 100;
                message = 'ğŸ‰ Sempurna! Tulisan Anda sangat baik dan rapi!';
                feedbackClass = 'bg-green-50 border-green-200 text-green-600';
                writingScore += score;
                
                // Vibrate on success
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100, 50, 100]);
                }
            } else if (accuracy > 70) {
                score = 85;
                message = 'ğŸ‘ Bagus sekali! Tulisan Anda sudah baik!';
                feedbackClass = 'bg-blue-50 border-blue-200 text-blue-600';
                writingScore += score;
            } else if (accuracy > 55) {
                score = 70;
                message = 'ğŸ˜Š Cukup baik! Terus berlatih untuk hasil yang lebih baik.';
                feedbackClass = 'bg-yellow-50 border-yellow-200 text-yellow-600';
                writingScore += score;
            } else if (accuracy > 40) {
                score = 50;
                message = 'ğŸ¤” Lumayan! Coba perhatikan bentuk huruf lebih teliti.';
                feedbackClass = 'bg-orange-50 border-orange-200 text-orange-600';
                writingScore += score;
            } else {
                score = 25;
                message = 'ğŸ’ª Terus berlatih! Ikuti panduan bentuk huruf dengan lebih hati-hati.';
                feedbackClass = 'bg-red-50 border-red-200 text-red-600';
                writingScore += score;
            }
            
            // Show feedback
            const feedback = document.getElementById('writingFeedback');
            const feedbackText = document.getElementById('feedbackText');
            
            if (feedback && feedbackText) {
                feedback.className = `mt-4 text-center writing-feedback ${feedbackClass} rounded-lg p-3`;
                feedbackText.textContent = `${message} (+${score} poin)`;
                feedback.classList.remove('hidden');
            }
            
            // Update score display
            const scoreElement = document.getElementById('writingScore');
            if (scoreElement) {
                scoreElement.textContent = writingScore;
            }
            
            // Update total score
            totalScore += score;
            localStorage.setItem('iqra_totalScore', totalScore.toString());
            updateDisplay();
            
            showMessage(message, score >= 70 ? 'success' : 'info');
        }

        function calculateStrokeDensity(imageData) {
            const pixels = imageData.data;
            let strokePixels = 0;
            let totalPixels = pixels.length / 4;
            
            for (let i = 3; i < pixels.length; i += 4) {
                if (pixels[i] > 0) {
                    strokePixels++;
                }
            }
            
            // Normalize stroke density (optimal range: 5-15% of canvas)
            const density = strokePixels / totalPixels;
            if (density >= 0.05 && density <= 0.15) {
                return 1.0;
            } else if (density < 0.05) {
                return density / 0.05;
            } else {
                return Math.max(0.3, 1.0 - (density - 0.15) / 0.1);
            }
        }

        function calculateCoverage(imageData) {
            const width = writingCanvas.width;
            const height = writingCanvas.height;
            const pixels = imageData.data;
            
            // Check coverage in different regions of the canvas
            let centerCoverage = 0;
            let totalCenterPixels = 0;
            
            // Focus on center area (where Arabic letters typically sit)
            const startX = Math.floor(width * 0.2);
            const endX = Math.floor(width * 0.8);
            const startY = Math.floor(height * 0.2);
            const endY = Math.floor(height * 0.8);
            
            for (let y = startY; y < endY; y++) {
                for (let x = startX; x < endX; x++) {
                    const index = (y * width + x) * 4 + 3; // Alpha channel
                    totalCenterPixels++;
                    if (pixels[index] > 0) {
                        centerCoverage++;
                    }
                }
            }
            
            return totalCenterPixels > 0 ? centerCoverage / totalCenterPixels : 0;
        }

        function nextWritingLetter() {
            const currentIndex = writingLetters.findIndex(l => l.letter === currentLetter);
            const nextIndex = (currentIndex + 1) % writingLetters.length;
            const nextLetter = writingLetters[nextIndex];
            
            // Simulate click on the next letter button
            const nextButton = document.querySelector(`[onclick*="${nextLetter.letter}"]`);
            if (nextButton) {
                selectWritingLetter(nextLetter.letter, nextLetter.name);
            }
        }

        // Ujian Functions
        function loadUjianMenu() {
            updateDisplay();
            
            let content = `
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-bold text-orange-600 mb-4">ğŸ“ Evaluasi Kemampuan</h3>
                    <p class="text-gray-600">Uji kemampuan membaca huruf Hijaiyah Anda!</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Ujian Huruf -->
                    <div class="game-card bg-gradient-to-br from-blue-400 to-blue-600 text-white rounded-xl p-6 shadow-lg" onclick="startUjianHuruf()">
                        <div class="text-center">
                            <div class="text-5xl mb-3">ğŸ“–</div>
                            <h4 class="text-xl font-bold mb-2">Ujian Huruf</h4>
                            <p class="text-blue-100 text-sm mb-3">Baca 10 huruf secara acak</p>
                            <div class="bg-white/20 px-3 py-1 rounded-full text-xs font-bold">ğŸ¤ Rekam Suara</div>
                        </div>
                    </div>
                    
                    <!-- Ujian Pola -->
                    <div class="game-card bg-gradient-to-br from-red-400 to-red-600 text-white rounded-xl p-6 shadow-lg" onclick="startUjianPola()">
                        <div class="text-center">
                            <div class="text-5xl mb-3">ğŸµ</div>
                            <h4 class="text-xl font-bold mb-2">Ujian Pola</h4>
                            <p class="text-red-100 text-sm mb-3">Baca pola huruf seperti Iqra'</p>
                            <div class="bg-white/20 px-3 py-1 rounded-full text-xs font-bold">ğŸ¤ Rekam Suara</div>
                        </div>
                    </div>
                    
                    <!-- Ujian Komprehensif -->
                    <div class="game-card bg-gradient-to-br from-purple-400 to-purple-600 text-white rounded-xl p-6 shadow-lg" onclick="startUjianKomprehensif()">
                        <div class="text-center">
                            <div class="text-5xl mb-3">ğŸ†</div>
                            <h4 class="text-xl font-bold mb-2">Ujian Lengkap</h4>
                            <p class="text-purple-100 text-sm mb-3">Evaluasi menyeluruh Jilid 1</p>
                            <div class="bg-white/20 px-3 py-1 rounded-full text-xs font-bold">25 Soal</div>
                        </div>
                    </div>
                    
                    <!-- Laporan Kemajuan -->
                    <div class="game-card bg-gradient-to-br from-teal-400 to-teal-600 text-white rounded-xl p-6 shadow-lg" onclick="showProgressReport()">
                        <div class="text-center">
                            <div class="text-5xl mb-3">ğŸ“Š</div>
                            <h4 class="text-xl font-bold mb-2">Laporan</h4>
                            <p class="text-teal-100 text-sm mb-3">Lihat kemajuan belajar Anda</p>
                            <div class="bg-white/20 px-3 py-1 rounded-full text-xs font-bold">Statistik</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('ujian-content').innerHTML = content;
            document.getElementById('ujian-controls').innerHTML = '';
        }

        // Utility Functions
        function showMessage(message, type = 'info') {
            // Create a temporary message element
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg font-bold text-sm shadow-lg transition-all duration-300 transform translate-x-full`;
            
            // Set colors based on type
            switch(type) {
                case 'success':
                    messageDiv.className += ' bg-green-500 text-white';
                    break;
                case 'error':
                    messageDiv.className += ' bg-red-500 text-white';
                    break;
                case 'info':
                default:
                    messageDiv.className += ' bg-blue-500 text-white';
                    break;
            }
            
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            // Animate in
            setTimeout(() => {
                messageDiv.classList.remove('translate-x-full');
            }, 100);
            
            // Animate out and remove
            setTimeout(() => {
                messageDiv.classList.add('translate-x-full');
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
        }

        function closeModal() {
            document.getElementById('successModal').classList.add('hidden');
            document.getElementById('successModal').classList.remove('flex');
        }

        // Profile Functions
        function showProfileSetup() {
            document.getElementById('profileModal').classList.remove('hidden');
            document.getElementById('profileModal').classList.add('flex');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.add('hidden');
            document.getElementById('profileModal').classList.remove('flex');
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewPhoto').src = e.target.result;
                    document.getElementById('previewPhoto').style.display = 'block';
                    document.getElementById('previewAvatar').style.display = 'none';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveProfile() {
            const name = document.getElementById('nameInput').value.trim();
            const className = document.getElementById('classInput').value;
            const photoSrc = document.getElementById('previewPhoto').src;
            
            if (!name || !className) {
                showMessage('âŒ Mohon lengkapi nama dan kelas!', 'error');
                return;
            }
            
            // Save to localStorage
            localStorage.setItem('iqra_userName', name);
            localStorage.setItem('iqra_userClass', className);
            if (photoSrc && photoSrc !== '') {
                localStorage.setItem('iqra_userPhoto', photoSrc);
            }
            
            // Update display
            document.getElementById('userName').textContent = name;
            document.getElementById('userClass').textContent = className;
            
            if (photoSrc && photoSrc !== '') {
                document.getElementById('userPhoto').src = photoSrc;
                document.getElementById('userPhoto').style.display = 'block';
                document.getElementById('defaultAvatar').style.display = 'none';
            }
            
            // Show student identity section instead of profile section
            document.getElementById('studentIdentity').classList.remove('hidden');
            document.getElementById('setupProfileBtn').style.display = 'none';
            
            closeProfileModal();
            showMessage(`âœ… Profil ${name} berhasil disimpan!`, 'success');
        }

        function editProfile() {
            // Load current data
            document.getElementById('nameInput').value = localStorage.getItem('iqra_userName') || '';
            document.getElementById('classInput').value = localStorage.getItem('iqra_userClass') || '';
            
            const savedPhoto = localStorage.getItem('iqra_userPhoto');
            if (savedPhoto) {
                document.getElementById('previewPhoto').src = savedPhoto;
                document.getElementById('previewPhoto').style.display = 'block';
                document.getElementById('previewAvatar').style.display = 'none';
            }
            
            showProfileSetup();
        }

        // Load saved profile on page load
        function loadSavedProfile() {
            const savedName = localStorage.getItem('iqra_userName');
            const savedClass = localStorage.getItem('iqra_userClass');
            const savedPhoto = localStorage.getItem('iqra_userPhoto');
            
            if (savedName && savedClass) {
                document.getElementById('userName').textContent = savedName;
                document.getElementById('userClass').textContent = savedClass;
                
                if (savedPhoto) {
                    document.getElementById('userPhoto').src = savedPhoto;
                    document.getElementById('userPhoto').style.display = 'block';
                    document.getElementById('defaultAvatar').style.display = 'none';
                }
                
                document.getElementById('studentIdentity').classList.remove('hidden');
                document.getElementById('setupProfileBtn').style.display = 'none';
            }
        }

        // Placeholder functions for other games
        function startMemoryGame() {
            showMessage('ğŸ§  Memory Game akan segera hadir!', 'info');
        }

        function startQuizGame() {
            showMessage('â“ Quiz Game akan segera hadir!', 'info');
        }

        function startSpeedGame() {
            showMessage('âš¡ Speed Game akan segera hadir!', 'info');
        }

        function startPatternGame() {
            showMessage('ğŸ¯ Pattern Game akan segera hadir!', 'info');
        }

        function startUjianHuruf() {
            showMessage('ğŸ“– Ujian Huruf akan segera hadir!', 'info');
        }

        function startUjianPola() {
            showMessage('ğŸµ Ujian Pola akan segera hadir!', 'info');
        }

        function startUjianKomprehensif() {
            showMessage('ğŸ† Ujian Komprehensif akan segera hadir!', 'info');
        }

        function showProgressReport() {
            showMessage('ğŸ“Š Laporan Kemajuan akan segera hadir!', 'info');
        }

        function testMicrophone() {
            showMessage('ğŸ¤ Fitur tes mikrofon akan segera hadir!', 'info');
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            updateDisplay();
            loadSavedProfile();
            console.log('Iqra Digital Jilid 1 initialized successfully');
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97534700004591cb',t:'MTc1NjIxMDc2NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
